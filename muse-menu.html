<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Muse Brewing — Taproom Menu</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, sans-serif; }
  </style>
</head>
<body class="bg-neutral-900 text-neutral-100 min-h-screen">

  <!-- HEADER -->
  <header class="w-full bg-neutral-900 px-10 pt-8 pb-6 sticky top-0 z-50 flex items-center gap-6">
    <div class="h-14 w-14 bg-amber-400 rounded-xl ring-4 ring-black/20"></div>
    <div>
      <h1 class="text-4xl tracking-widest font-semibold">MUSE BREWING</h1>
      <div class="text-sm text-neutral-400 tracking-[0.3em] uppercase">Taproom Menu</div>
    </div>
  </header>

  <!-- CONTENT WRAPPER -->
  <main id="menu" class="px-10 py-8 max-w-6xl mx-auto space-y-10"></main>

  <!-- FOOTER -->
  <footer class="w-full bg-neutral-900 text-neutral-100 ring-1 ring-neutral-700 px-10 py-4 sticky bottom-0 flex items-center text-sm">
    <div class="tracking-[0.3em] uppercase opacity-70">● Fresh • Local • Independent</div>
    <div id="updated" class="ml-auto opacity-60"></div>
  </footer>

  <script>
    // ========= GOOGLE SHEET CSV/TSV URL =========
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6LQ4iy20_1t8HXk-cBRYgUNSREv4rM5hFuM2oPyoHqyNPVWiWxK2JHZn7APZRwURJwwaT04oGDTZt/pub?gid=0&single=true&output=csv";

    // ========= FETCH + PARSE (CSV or TSV) =========
    async function fetchCSV() {
      try {
        const res = await fetch(
  	SHEET_URL + (SHEET_URL.includes("?") ? "&" : "?") + "t=" + Date.now(),
  	{ cache: "no-store" }
	);
        const text = await res.text();
        return parseCSV(text);
      } catch (e) {
        console.error("Fetch error:", e);
        return [];
      }
    }

    function parseCSV(str) {
      // Split into lines (handles \r\n, \n, or \r)
      const lines = str.split(/\r\n|\n|\r/).filter(l => l.trim().length);
      if (lines.length === 0) return [];

      // Detect delimiter: tab (TSV) or comma (CSV)
      const headerLine = lines[0];
      const isTSV = headerLine.includes("\t");
      const delimiter = isTSV ? "\t" : ",";

      const headers = headerLine.split(delimiter);

      return lines.slice(1).map(row => {
        let cols;
        if (isTSV) {
          // Simple tab split for TSV
          cols = row.split("\t");
        } else {
          // Comma split that respects quoted CSV fields
          cols = row
            .split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
            .map(c => c.replace(/^"|"$/g, ""));
        }

        const obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = (cols[i] || "").trim();
        });
        return obj;
      });
    }

    // ========= BUILD MENU UI =========
    function buildMenu(data) {
      const container = document.getElementById("menu");
      container.innerHTML = "";

      console.log("Raw data rows:", data.length, data);

      // Show if OnTap is TRUE/YES/1 or blank
      const onTap = data.filter(x => {
        const v = String(x.OnTap || "").trim().toLowerCase();
        if (!v) return true;
        return v === "true" || v === "yes" || v === "1";
      });

      if (onTap.length === 0) {
        container.innerHTML = '<div class="text-center text-xl opacity-60">No beers on tap.</div>';
        document.getElementById("updated").textContent = "Updated: " + new Date().toLocaleString();
        return;
      }

      // Group by Style
      const grouped = {};
      onTap.forEach(item => {
        const style = item.Style || "Other";
        if (!grouped[style]) grouped[style] = [];
        grouped[style].push(item);
      });

      // Style display order
      const styleOrder = {
        IPA: 1,
        Lager: 2,
        Stout: 3,
        Brown: 4,
        Sour: 5,
        Cider: 6,
        "Hard Soda": 7,
        Other: 99
      };

      const sections = Object.keys(grouped).sort(
        (a, b) => (styleOrder[a] || 50) - (styleOrder[b] || 50)
      );

      sections.forEach(style => {
        const beers = grouped[style];
        const sec = document.createElement("section");
        sec.innerHTML = `
          <h2 class="mb-4 text-xl font-semibold tracking-wider text-amber-400">${style}</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${beers.map(b => `
              <div class="rounded-2xl p-5 bg-neutral-800/70 ring-1 ring-neutral-700">
                <div class="flex justify-between items-baseline">
                  <h3 class="text-2xl font-semibold tracking-wide">${b.Name}</h3>
                  <span class="text-neutral-400 text-sm">${b.Style}</span>
                </div>
                <div class="mt-2 text-sm flex gap-4">
                  ${b.ABV ? `<span class="text-amber-400 font-medium">${parseFloat(b.ABV).toFixed(1)}% ABV</span>` : ""}
                  ${b.IBU ? `<span class="text-neutral-400">• ${b.IBU} IBU</span>` : ""}
                </div>
                ${b.Description ? `<p class="mt-3 text-neutral-400 text-sm">${b.Description}</p>` : ""}
                <div class="mt-4 text-center">
                  <div class="rounded-xl px-3 py-2 bg-neutral-900 ring-1 ring-neutral-700 inline-block">
                    <div class="text-xs uppercase tracking-wide">16oz</div>
                    <div class="text-lg font-semibold">$${b.Price_16oz}</div>
                  </div>
                </div>
              </div>
            `).join("")}
          </div>
        `;
        container.appendChild(sec);
      });

      document.getElementById("updated").textContent =
        "Updated: " + new Date().toLocaleString();
    }

    // ========= INITIALIZE =========
    async function init() {
      const data = await fetchCSV();
      buildMenu(data);
    }

    init();
    setInterval(init, 5 * 60 * 1000); // refresh every 5 minutes
  </script>

</body>
</html>